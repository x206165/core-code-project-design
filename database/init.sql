-- REMOVE DATA
-- DELETE FROM PERSON;
-- DELETE FROM CATEGORY;

-- REMOVE TABLE AND SEQUENCE
-- DROP TABLE CATEGORY;
-- DROP SEQUENCE SQ_CATEGORY;

-- REMOVE TABLE AND SEQUENCE
-- DROP TABLE PERSON;
-- DROP SEQUENCE SQ_PERSON;

ALTER SESSION SET CONTAINER=XEPDB1;

-- PERSON CREATION
CREATE TABLE APPUSER.PERSON (
	PERSON NUMBER,
	EMAIL VARCHAR2(100) UNIQUE NOT NULL,
	PASSWORD VARCHAR2(1000) NOT NULL,
	PERSON_TOKEN VARCHAR2(1000) NOT NULL,
	FIRST_NAME VARCHAR2(100) NOT NULL,
	LAST_NAME VARCHAR2(100) NOT NULL,
	ADD_DATE DATE DEFAULT SYSDATE,
	MOD_DATE DATE,
	PRIMARY KEY(PERSON)
);

-- PERSON SEQUENCE
CREATE SEQUENCE APPUSER.SQ_PERSON NOCACHE;

-- CATEGORY CREATION
CREATE TABLE APPUSER.CATEGORY(
	CATEGORY NUMBER,
	PERSON NUMBER NOT NULL,
	NAME VARCHAR2(100) NOT NULL,
	DESCRIPTION VARCHAR2(200) NOT NULL,
	ADD_DATE DATE DEFAULT SYSDATE,
	MOD_DATE DATE,
	PRIMARY KEY(CATEGORY),
	FOREIGN KEY(PERSON) REFERENCES APPUSER.PERSON(PERSON)
);

-- CATEGORY SEQUENCE
CREATE SEQUENCE APPUSER.SQ_CATEGORY NOCACHE;


-- ACCOUNT CREATION 
CREATE TABLE APPUSER.ACCOUNT(
    ACCOUNT_ID NUMBER,
    PERSON NUMBER NOT NULL,
    NAME VARCHAR2(100) NOT NULL,
    BANK_NAME VARCHAR2(200) NOT NULL, 
    ACCOUNT_BALANCE NUMBER(20,6), 
    CURRENCY_ID VARCHAR2(3) NOT NULL, 
    ADD_DATE DATE DEFAULT SYSDATE,
    MOD_DATE DATE,
    PRIMARY KEY(ACCOUNT_ID),
    FOREIGN KEY(PERSON) REFERENCES APPUSER.PERSON(PERSON)
);



-- TRANSACTION CREATION 
CREATE TABLE APPUSER.TRANSACTIONS(
    TXN_ID NUMBER NOT NULL, 
    DEBIT_ACCOUNT_ID NUMBER,
    CREDIT_ACCOUNT_ID NUMBER,
    PERSON NUMBER NOT NULL,
    DESCRIPTION VARCHAR2(100) NOT NULL,
    ACCOUNT_NUMBER NUMBER, 
    AMOUNT NUMBER(20,6), 
    DEBIT_CURRENCY VARCHAR2(3), 
    CREDIT_CURRENCY VARCHAR(3), 
    ADD_DATE DATE DEFAULT SYSDATE,
    PRIMARY KEY(TXN_ID),
    FOREIGN KEY(PERSON) REFERENCES APPUSER.PERSON(PERSON),
    FOREIGN KEY(DEBIT_ACCOUNT_ID) REFERENCES APPUSER.ACCOUNT(ACCOUNT_ID),
    FOREIGN KEY(CREDIT_ACCOUNT_ID) REFERENCES APPUSER.ACCOUNT(ACCOUNT_ID)
);


-- TRANSACTION SEQUENCE
CREATE SEQUENCE APPUSER.SQ_TRANSACTIONS NOCACHE;

-- REMOVE TABLE AND SEQUENCE
-- DROP TABLE ACCOUNT;
-- DROP SEQUENCE SQ_ACCOUNT;

-- CREATE FUNCTION
CREATE OR REPLACE FUNCTION APPUSER.API_TOKEN(PSECRET VARCHAR2) RETURN VARCHAR2
IS
  	VRESULT VARCHAR2(4000);
BEGIN
	SELECT UTL_RAW.CAST_TO_VARCHAR2(UTL_I18N.STRING_TO_RAW(STANDARD_HASH(PSECRET, 'MD5'), 'AL32UTF8')) INTO VRESULT from dual;
	RETURN VRESULT;
END API_TOKEN;



-- INSERTS DE DATA INICIAL 

--INSERT INTO APPUSER.ACCOUNT (ACCOUNT_ID,PERSON,NAME,BANK_NAME,ACCOUNT_NUMBER,ACCOUNT_BALANCE,CURRENCY_ID,ADD_DATE,MOD_DATE) VALUES 
--(SQ_ACCOUNT.NEXTVAL,1,'Proveedor','Banco de gobierno',123456789,200,'BTC',TIMESTAMP '2023-02-05 06:20:51.000000',NULL)
--,(SQ_ACCOUNT.NEXTVAL,1,'Gastos','Chivo Wallet',876,30,'BTC',TIMESTAMP '2023-02-05 06:32:06.000000',NULL)
--;
--
--INSERT INTO APPUSER.PERSON (PERSON,EMAIL,PASSWORD,PERSON_TOKEN,FIRST_NAME,LAST_NAME,ADD_DATE,MOD_DATE) VALUES 
--(SQ_PERSON.NEXTVAL,'ricardo.garay@ti.com','$2a$08$IH9VD0DwNXaKIgL5aD1uMOm6dH.zajSb.IDBwEqWzwppSAD6x4pFK','97962E1EFDCEBD601CE00B721838E791','Ricardo','Garay',TIMESTAMP '2023-02-05 05:56:21.000000',TIMESTAMP '2023-02-05 06:30:14.000000')
--;
--
----Creating user test@telus.com and 'test2@telus.com' with pass=admin
--INSERT INTO PERSON (PERSON,EMAIL,PASSWORD,PERSON_TOKEN,FIRST_NAME,LAST_NAME,ADD_DATE,MOD_DATE) VALUES
--(SQ_PERSON.NEXTVAL,'test@telus.com','$2a$08$59ux1EuJ9Y.RNnHHCpIQ7OYGXmi.wPOGSpbnnDqeOpXOfVqFCzdp6','A6BC7C372E3EBF5277B69899B315B4BF','Cristian','Padilla',TIMESTAMP'2023-02-05 06:30:20.0',TIMESTAMP'2023-02-05 06:31:24.0'),
--(SQ_PERSON.NEXTVAL,'test2@telus.com','$2a$08$3/O.ed.daGYJkQSFovgQJODUKVo8ozO0YMvSFZL4kBdq2UOOXGxVe','AF4FE34052A94C9E95B37EDC08B479A2','Alex','Jim�nez',TIMESTAMP'2023-02-05 06:30:44.0',NULL);
--
--INSERT INTO CATEGORY (CATEGORY,PERSON,NAME,DESCRIPTION,ADD_DATE,MOD_DATE) VALUES
--(SQ_CATEGORY.NEXTVAL,2,'Categoria 1 Alex','Categoría 1 Alex desc',TIMESTAMP'2023-02-05 06:31:04.0',NULL),
--(SQ_CATEGORY.NEXTVAL,2,'Categoria 2 Alex','Categoria 2 Alex',TIMESTAMP'2023-02-05 06:31:11.0',NULL),
--(SQ_CATEGORY.NEXTVAL,2,'Categoria 3 Alex','Categoria 3 Alex',TIMESTAMP'2023-02-05 06:31:16.0',NULL),
--(SQ_CATEGORY.NEXTVAL,1,'Categoria 1 Cristian','Categoria 1 Cristian desc',TIMESTAMP'2023-02-05 06:31:38.0',NULL),
--(SQ_CATEGORY.NEXTVAL,1,'Categoria 2 Cristian','Categoria 2 Cristian',TIMESTAMP'2023-02-05 06:32:05.0',NULL),
--(SQ_CATEGORY.NEXTVAL,1,'Categoria 3 Cristian','Categoria 3 Cristian',TIMESTAMP'2023-02-05 06:32:22.0',NULL);
--
--INSERT INTO ACCOUNT (ACCOUNT_ID,PERSON,NAME,BANK_NAME,ACCOUNT_NUMBER,ACCOUNT_BALANCE,CURRENCY_ID,ADD_DATE,MOD_DATE) VALUES
--(SQ_ACCOUNT.NEXTVAL,1,'MyAccountName','My bank 1',999,5000.51,'1',TIMESTAMP'2023-02-05 06:35:36.0',TIMESTAMP'2023-02-05 06:35:36.0'),
--(SQ_ACCOUNT.NEXTVAL,2,'MyAccountName2','My bank 2',888,4000.51,'1',TIMESTAMP'2023-02-05 06:35:40.0',TIMESTAMP'2023-02-05 06:35:40.0');
--
--INSERT INTO TRANSACTIONS (TXN_ID,DEBIT_ACCOUNT_ID,CREDIT_ACCOUNT_ID,PERSON,DESCRIPTION,ACCOUNT_NUMBER,AMOUNT,DEBIT_CURRENCY,CREDIT_CURRENCY,ADD_DATE) VALUES
--(SQ_TRANSACTIONS.NEXTVAL,1,2,1,'Test txn 1',1,200,30,50,TIMESTAMP'2023-02-05 06:37:03.0'),
--(SQ_TRANSACTIONS.NEXTVAL,2,1,1,'Test txn 2',1,200,30,50,TIMESTAMP'2023-02-05 06:37:15.0');


/
